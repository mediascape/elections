<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="result-table" >


<template>
<style>
:host {
    display: block;
    background-color: white;
  }
   body{
    background-color: white;
  }
table {

    margin-left: 10%;
    width: 80%;
    background: #fff;
    font-family:RobotoDraft, Helvetica Neue, Helvetica, Arial;
}
td, th {

    border: 1px solid #999999;
}

th {
	 background:#003040;
     background:linear-gradient(#003040, #002535);


    color: #fff;
    white-space: nowrap;
}
tbody th {
	background:#003040;
    background:linear-gradient(#003040, #002535);
	border: 1px solid #999999;
}
tbody tr:nth-child(2n-1) {
    background-color: #f5f5f5;
    transition: all .125s ease-in-out;
}
tbody tr:hover {
    background-color: rgba(129,200,200,.3);
}


#placeSelection{
	font-size: 20px;
    border-radius: 6px;
    margin-bottom: 10px;

    background-color: white;
    font-family:RobotoDraft, "Helvetica Neue", Helvetica, Arial;
}
#container{
    height:100%;
    margin-top:0%;
    background-color: white;
    border:solid 1px;
  }

input{
	width:30%;
	height:40px;
	border-radius: 6px;
	margin-bottom: 10px;
	font-family:RobotoDraft, "Helvetica Neue", Helvetica, Arial;

}
@media (max-width:340px){
			#resultsTab{display:none;}
 			#resultsTab_horizontal{display:none;}
 			#resultsTab_pip{display:block;}

 			#placeSelection{font-size:15px;}
	    	#counting{font-size:15px;}

}
@media (min-width:341px) and (max-width:450px){
	    	#resultsTab{font-size:8px;display:block;}
	    	#resultsTab_horizontal{font-size:10px;display:none}

 		#resultsTab_pip{display:none;}
	    	#placeSelection{font-size:9px;}
	    	#counting{font-size:10px;}



}
@media (min-width:451px) and (max-width:600px){
	    	#resultsTab{font-size:8px;}
	    	#resultsTab_horizontal{font-size:10px;}
	    	#placeSelection{font-size:10px;}
	    	#counting{font-size:10px;}



}
@media (min-width:601px) and (max-width:800px){

	    	#placeSelection{font-size:15px;}
	    	#counting{font-size:15px;}

}
@media (min-width:801px) {
	    	#resultsTab{font-size:20px;}
	    	#placeSelection{font-size:20px;}
	    	#counting{font-size:20px;}

}
 @media (min-width:1000px) and (min-aspect-ratio:8/1){
 			#resultsTab{display:none;font-size:15px;}
 			#resultsTab_horizontal{display:block;}
 			#resultsTab_pip{display:none;}
 			#placeSelection{font-size:15px;}
	    	#counting{font-size:15px;}


 }
 @media (min-width:1000px) and (min-aspect-ratio:9/1){
 			#resultsTab{display:none;font-size:15px;}
 			#resultsTab_horizontal{display:block;}
 			#resultsTab_pip{display:none;}
 			#placeSelection{font-size:15px;}
	    	#counting{font-size:15px;}


 }
  @media (min-width:1000px) and (min-aspect-ratio:17/13){
  			#resultsTab{display:block;}
 			#resultsTab_horizontal{display:none;}
 			#resultsTab_pip{display:none;}
 			#placeSelection{font-size:15px;}
	    	#counting{font-size:15px;}

  }
  @media (min-width:740px) and (min-aspect-ratio:7/9){
    #resultsTab{display:block;}
   #resultsTab_horizontal{display:none;}
   #resultsTab_pip{display:none;}
   #placeSelection{font-size:15px;}
    #counting{font-size:15px;}

  }
  @media (min-width:1000px) and (min-aspect-ratio:13/9){
  			#resultsTab{display:block;}
 			#resultsTab_horizontal{display:none;}
 			#resultsTab_pip{display:none;}
 			#placeSelection{font-size:15px;}
	    	#counting{font-size:15px;}

  }



</style>
<div id='container' >
<iron-ajax id="data" auto url="2015.json" handleAs="json" last-response="{{response}}"></iron-ajax>
<div id='selectDiv' style='margin-top:2px;text-align:center;font-family:RobotoDraft, "Helvetica Neue", Helvetica, Arial;color:green;'>
<select id="placeSelection" value='{{value}}' on-change="valueChanged">

  <option value="donostia">Donostia</option>
  <option value="bilbo">Bilbo</option>
  <option value="gasteiz">Gasteiz</option>
  <option value="irunea">Irunea</option>
  <option value="gipuzkoa">Gipuzkoa</option>
  <option value="bizkaia">Bizkaia</option>
  <option value="araba">Araba</option>
  <option value="nafarroa">Nafarroa</option>
</select>
<span id='counting' style='font-weight:bold;'></span>
</span>

<div style='text-align:center;'>
<input id='actualdata' type='button' value='2015' style='background-color:#003040;border-color:#003040;color:white' ></input>
<input id='pastdata' type='button' value='2011' style='background-color:#AFCED0;border-color:#AFCED0;color:#3399FF' ></input>
</div>
</div>
</template>
</dom-module>
<script>
Polymer({

    is:'result-table',
    behaviors:[ComponentQueryBehavior,ComponentStatusBehavior],
    properties:{
      where:{
        type:String,
        value:'',
        notify: true
      },
      timestamp:{
         type:Number,
         value:0,
         observer:'timestampChanged'
      },
      value:{
         type:String,
         observer:'valueChanged'
      },
       	prevTime:{
          type:Number,
          value:1432509468
        },
        customCmd:{
            type:String,
            value:'',
            observer: 'customCmdReceived'
        }
    },
    resultsData:{},
    time:'',
    where:'',
   	actualShowing:true,


	ready:function(){
		document.addEventListener ('motion-ready',this.smReady.bind(this));

		var scope=this;
		this.$.actualdata.addEventListener('tap',function(){
			scope.actualData();
		});
		this.$.pastdata.addEventListener('tap',function(){
			scope.pastData();
		});

		this.resultsData={};
		this.$.data.addEventListener("response",function(e){
			scope.resultsData=e.detail.response;


			for(var i=1;i<scope.resultsData.results.length;i++){
				if(scope.timestamp===scope.resultsData.results[i].time){
					scope.time=i;
				}
			}
			scope.where=3;//Iruñea por defecto
			scope.time=1;
			var shape=1;
			scope.$.placeSelection.value='irunea';//iruñea por defecto
			scope.drawTable(scope.resultsData,scope.time,scope.where,shape);

		});


	},
	smReady:function(){
  		// Sharemotion objetua lortu
  		var _this=this;
   		this.sm = mediascape.AdaptationToolkit.SharedMotion();
  		// ebentuak entzun ta jaso
  		var handler = function (e) {
      		_this.timestamp=1432509468+Math.round(e.pos);


      	};
    	this.sm.mapp.motions.shared.on("timeupdate", handler);
	},
	actualData:function(){
		this.$.pastdata.style.backgroundColor='#AFCED0';
		this.$.pastdata.style.color='#003040';
		this.$.pastdata.style.borderColor='#AFCED0';
		this.$.actualdata.style.backgroundColor='#003040';
		this.$.actualdata.style.color='white';
		this.$.actualdata.style.borderColor='#003040';
		this.actualShowing=true;

		var shape=0;

		if(this.children[0].querySelector('#resultsTab').style.display==='block'){
			shape=1;
		}
		else if(this.children[0].querySelector('#resultsTab_horizontal').style.display==='block'){
			shape=2;
		}
		else if(this.children[0].querySelector('#resultsTab_pip').style.display==='block'){
			shape=3;
		}

		this.children[0].removeChild(this.children[0].querySelector('#resultsTab'));
		this.children[0].removeChild(this.children[0].querySelector('#resultsTab_horizontal'));
		this.children[0].removeChild(this.children[0].querySelector('#resultsTab_pip'));
		this.drawTable(this.resultsData,this.time,this.where,shape);

	},
	pastData:function(){
		this.$.actualdata.style.backgroundColor='#AFCED0';
		this.$.actualdata.style.color='#003040';
		this.$.actualdata.style.borderColor='#AFCED0';
		this.$.pastdata.style.backgroundColor='#003040';
		this.$.pastdata.style.color='white';
		this.$.pastdata.style.borderColor='#003040';

		var shape=0;

		if(this.children[0].querySelector('#resultsTab').style.display==='block'){
			shape=1;
		}
		else if(this.children[0].querySelector('#resultsTab_horizontal').style.display==='block'){
			shape=2;
		}
		else if(this.children[0].querySelector('#resultsTab_pip').style.display==='block'){
			shape=3;
		}


		this.children[0].removeChild(this.children[0].querySelector('#resultsTab'));
		this.children[0].removeChild(this.children[0].querySelector('#resultsTab_horizontal'));
		this.children[0].removeChild(this.children[0].querySelector('#resultsTab_pip'));
		this.time=0;
		this.actualShowing=false;
		this.drawTable(this.resultsData,this.time,this.where,shape);

	},
	timestampChanged:function(){

		var interval=10;
		var prev=this.time;
		if(this.resultsData.results!==undefined){
		var nextTs=false;
			for(var i=1;i<this.resultsData.results.length;i++){
					if(this.timestamp===parseInt(this.resultsData.results[i].time))
					{

						 this.time=i;
						nextTs=true;
					}

			}
			if(nextTs===false){
				for(var i=1;i<this.resultsData.results.length;i++){
					if(this.timestamp>parseInt(this.resultsData.results[i].time) && this.timestamp<parseInt(this.resultsData.results[i+1].time)){
						this.time=i;

					}
				}
			}

			if(prev!=this.time){
				if(this.actualShowing===true){

					var shape=0;

					if(this.children[0].querySelector('#resultsTab').style.display==='block'){
						shape=1;
					}
					else if(this.children[0].querySelector('#resultsTab_horizontal').style.display==='block'){
						shape=2;
					}
					else if(this.children[0].querySelector('#resultsTab_pip').style.display==='block'){
			        shape=3;
		}

					this.children[0].removeChild(this.children[0].querySelector('#resultsTab'));
					this.children[0].removeChild(this.children[0].querySelector('#resultsTab_horizontal'));
					this.children[0].removeChild(this.children[0].querySelector('#resultsTab_pip'));
					this.drawTable(this.resultsData,this.time,this.where,shape);
				}
			//	this.prevTime = this.timestamp;
			}


		}
	},

	valueChanged:function(){


		var x=this.$.placeSelection;

  	if (x.value==='donostia') where=0;
		else if(x.value==='bilbo') where=1;
		else if(x.value==='gasteiz') where =2;
		else if(x.value==='irunea') where=3;
		else if(x.value==='gipuzkoa') where=4;
		else if(x.value==='bizkaia') where=5;
		else if(x.value==='araba') where =6;
		else if(x.value==='nafarroa') where=7;
		var shape=0;

		if(this.children[0].querySelector('#resultsTab').style.display==='block'){
			shape=1;
		}
		else if(this.children[0].querySelector('#resultsTab_horizontal').style.display==='block'){
			shape=2;
		}
		else if(this.children[0].querySelector('#resultsTab_pip').style.display==='block'){
			shape=3;
		}
		this.children[0].removeChild(this.children[0].querySelector('#resultsTab'));
		this.children[0].removeChild(this.children[0].querySelector('#resultsTab_horizontal'));
		this.children[0].removeChild(this.children[0].querySelector('#resultsTab_pip'));
    this.where = where;
    this.drawTable(this.resultsData,this.time,this.where,shape);


	},
	drawTable:function(results,time,where,shape){

		this.$.counting.innerHTML='Escrutado: '+results.results[time].places[where].counting;
		if(this.$.counting.innerHTML.indexOf('%')<=-1){
			this.$.counting.innerHTML=this.$.counting.innerHTML+'%';
		}

		//first option
		var table=document.createElement('table');
		table.style.fontSize=this.$.placeSelection.style.fontSize;
		table.id='resultsTab';
		var thead=document.createElement('thead');
		var trhead=document.createElement('tr');

		var candidatura=document.createElement('th');
		candidatura.innerHTML="CANDIDATURA";
		candidatura.style.padding= '0.75em 1em';
    	candidatura.style.textAlign='left';
		trhead.appendChild(candidatura);

		var image=document.createElement('th');
		trhead.appendChild(image);

		var votos=document.createElement('th');
		votos.innerHTML="VOTOS";
		votos.style.padding= '0.75em 1em';
    	votos.style.textAlign= 'left';
		trhead.appendChild(votos);

		var porcentaje=document.createElement('th');
		porcentaje.innerHTML="PORCENTAJE";
		porcentaje.style.padding= '0.75em 1em';
    	porcentaje.style.textAlign= 'left';
		trhead.appendChild(porcentaje);

		var escanios=document.createElement('th');
		escanios.innerHTML="ESCAÑOS";
		escanios.style.padding= '0.75em 1em';
    	escanios.style.textAlign= 'left';
		trhead.appendChild(escanios);
		thead.appendChild(trhead);
		table.appendChild(thead);

		var tbody=document.createElement('tbody');

		for(var i=0;i<5;i++){
			var tr=document.createElement('tr');
			var td1=document.createElement('td');
			td1.innerHTML=results.results[time].places[where].parties[i].name;
			td1.style.padding= '0.75em 1em';
    		td1.style.textAlign= 'left';
			tr.appendChild(td1);

			var tdimg=document.createElement('td');
			var img=document.createElement('img');
			img.src="/resources/images/icons/"+results.results[time].places[where].parties[i].icon;

			img.className='imgClass';
			img.style.width=this.$.actualdata.style.height;
			tdimg.appendChild(img);
			tdimg.style.padding= '0.75em 1em';
    		tdimg.style.textAlign= 'left';
			tr.appendChild(tdimg);

			var td2=document.createElement('td');
			td2.innerHTML=results.results[time].places[where].parties[i].votes;
			td2.style.padding= '0.75em 1em';
    		td2.style.textAlign= 'left';
			tr.appendChild(td2);

			var td3=document.createElement('td');
			td3.innerHTML=results.results[time].places[where].parties[i].percentage;
			td3.style.padding= '0.75em 1em';
    		td3.style.textAlign= 'left';
			tr.appendChild(td3);

			var td4=document.createElement('td');
			td4.innerHTML=results.results[time].places[where].parties[i].councillors;
			td4.style.padding= '0.75em 1em';
    		td4.style.textAlign= 'left';
			tr.appendChild(td4);
			tbody.appendChild(tr)
			table.appendChild(tbody);
		}
		this.children[0].appendChild(table);


		//second option
		var table=document.createElement('table');
		table.style.fontSize='15px';
		table.id='resultsTab_horizontal';

		var thead=document.createElement('thead');
		var trhead=document.createElement('tr');
		var th=document.createElement('th');
		th.style.padding='0em 0em';
		th.style.textAlign='center';
		th.innerHTML='CANDIDATURA';
		trhead.appendChild(th);
		for(var i=0;i<results.results[time].places[where].parties.length;i++){
			var th=document.createElement('th');
			var img=document.createElement('img');
			img.src="/resources/images/icons/"+results.results[time].places[where].parties[i].icon;
			img.style.width='30px';
			th.appendChild(img);
			th.style.padding='0em 0em';
			th.style.textAlign='center';
			trhead.appendChild(th);
		}
		thead.appendChild(trhead);
		table.appendChild(thead);

		var tbody=document.createElement('tbody');
		var tr=document.createElement('tr');

		var th=document.createElement('th');
		th.style.padding='0em 0em';
		th.style.textAlign='center';
		th.innerHTML='ESCAÑOS';
		tr.appendChild(th);
		for(var i=0;i<results.results[time].places[where].parties.length;i++){
			var td=document.createElement('td');
			td.innerHTML=results.results[time].places[where].parties[i].councillors;
			td.style.padding='0em 0em';
			td.style.textAlign='center';
			tr.appendChild(td);
		}
		tbody.appendChild(tr);
		table.appendChild(tbody);

		this.children[0].appendChild(table);

		//third option
		var table=document.createElement('table');
		table.style.fontSize='10px';
		table.id='resultsTab_pip';

		var thead=document.createElement('thead');
		var trhead=document.createElement('tr');
		var th=document.createElement('th');
		th.style.padding='0em 0em';
		th.style.textAlign='center';
		th.innerHTML='CANDIDATURA';
		trhead.appendChild(th);
		for(var i=0;i<3;i++){
			var th=document.createElement('th');
			var img=document.createElement('img');
			img.src="/resources/images/icons/"+results.results[time].places[where].parties[i].icon;
			img.style.width='30px';
			th.appendChild(img);
			th.style.padding='0em 0em';
			th.style.textAlign='center';
			trhead.appendChild(th);
		}
		thead.appendChild(trhead);
		table.appendChild(thead);

		var tbody=document.createElement('tbody');
		var tr=document.createElement('tr');

		var th=document.createElement('th');
		th.style.padding='0em 0em';
		th.style.textAlign='center';
		th.innerHTML='ESCAÑOS';
		tr.appendChild(th);
		for(var i=0;i<3;i++){
			var td=document.createElement('td');
			td.innerHTML=results.results[time].places[where].parties[i].councillors;
			td.style.padding='0em 0em';
			td.style.textAlign='center';
			tr.appendChild(td);
		}
		tbody.appendChild(tr);
		table.appendChild(tbody);

		this.children[0].appendChild(table);



		if(shape===1){
			this.children[0].querySelector('#resultsTab').style.display='block';
			this.children[0].querySelector('#resultsTab_horizontal').style.display='none';
			this.children[0].querySelector('#resultsTab_pip').style.display='none';

		}
		else if(shape===2){
			this.children[0].querySelector('#resultsTab').style.display='none';
			this.children[0].querySelector('#resultsTab_horizontal').style.display='block';
			this.children[0].querySelector('#resultsTab_pip').style.display='none';

		}
		else if(shape===3){
			this.children[0].querySelector('#resultsTab').style.display='none';
			this.children[0].querySelector('#resultsTab_horizontal').style.display='none';
			this.children[0].querySelector('#resultsTab_pip').style.display='block';

		}
	},
  customCmdReceived: function(data){
      console.log("DATA",data);
  }


});
 </script>
